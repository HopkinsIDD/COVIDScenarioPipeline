---
title: "gempyor/R interface tutorial"
output:
  html_notebook:
    toc: true
    toc_depth: 5
---


The General Epidemics Modeling Pipeline with Yterventions and Outcome Reporting, GEMPYOR is a large scale infectious disease dynamics model with configurable compartmental graph structure and interventions, to mulate metapopulation disease spread and health outcomes.

## Introduction:


![Fig. 1: The gempyor package (in Yellow) and the rest of the pipeline.](figs/context.png)

## Usage

### Import
Load reticulate, the python/R interface, and choose the python enviroment or executable where the gempyor package is installed (go to the Installation section at the end), then import the package

```{r}
library(reticulate)
library(tidyverse)
library(ggplot2)
library(tibble)
# reticulate::use_python(Sys.which('python'),require=TRUE)
reticulate::use_condaenv('covidSProd6')   
gempyor <- reticulate::import("gempyor")
```

### Building a simulator
We create an InferenceSimulator object here, using a config filepath. The code in this section is very much like what is present in filter_MC.R for the inference runs. It may take a while to run all of that. First build the object
```{r}
config_filepath = '../tests/npi/config_npi.yml'
gempyor_simulator <- gempyor$InferenceSimulator(
                                                config_path=config_filepath,
                                                run_id="test_run_id",
                                                prefix="test_prefix/",
                                                first_sim_index=1,
                                                scenario="inference",   # NPIs scenario to use
                                                deathrate="med",        # Outcome scenario to use
                                                stoch_traj_flag=FALSE,      
                                                spatial_path_prefix = '../tests/npi/' # prefix where to find the folder indicated in spatial_setup
)
```

## Additional functions
Some additional functions are provided for investigation of debug purpose:

### Parameters
```{r}
params_draw_df = gempyor_simulator$get_seir_parametersDF()   # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_spar_df>) or (bypass_FN=<some_spar_filename>)

## The array will be usefull later in the tutorial, to use it with the npi
params_draw_arr = gempyor_simulator$get_seir_parameters()    # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_spar_df>) or (bypass_FN=<some_spar_filename>)

params_draw_df
```

## NPIs

```{r}
npi_seir = gempyor_simulator$get_seir_npi()                  # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_snpi_df>) or (bypass_FN=<some_snpi_filename>)
npi_outcome = gempyor_simulator$get_outcome_npi()            # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_hnpi_df>) or (bypass_FN=<some_hnpi_filename>)
```
```{r}
npi_seir$getReductionDF()
```

```{r, fig.show=TRUE}
reduc <- npi_seir$getReduction(param = 'r0')
reduc <- reduc %>% rownames_to_column(var = 'geoid') 
reduc <- reduc %>% pivot_longer(cols=colnames(reduc %>% select(-geoid)), names_to = "date", values_to = "reduction")%>% mutate(date=as.Date(date))  # probably a very ugly way way to to this
reduc %>% ggplot(aes(x=date, y=reduction)) + geom_path() + facet_wrap(~ geoid)
```

```{r}
npi_outcome$getReductionDF() %>% select('parameter') %>% unique()
```

```{r, fig.show=TRUE}
reduc <- npi_outcome$getReduction(param = 'inciditoc_all')
reduc <- reduc %>% rownames_to_column(var = 'geoid') 
reduc <- reduc %>% pivot_longer(cols=colnames(reduc %>% select(-geoid)), names_to = "date", values_to = "reduction")%>% mutate(date=as.Date(date))  # probably a very ugly way way to to this
reduc %>% ggplot(aes(x=date, y=reduction)) + geom_path() + facet_wrap(~ geoid)
```
 ### SEIR Parameters
```{r,  fig.show=TRUE}
param_reduc = gempyor_simulator$get_seir_parameter_reduced(npi_seir=npi_seir) # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_spar_df>) or (bypass_FN=<some_spar_filename>)
param_reduc_from = gempyor_simulator$get_seir_parameter_reduced(npi_seir=npi_seir, p_draw=params_draw_arr) # could also accept (load_ID=True, sim_id2load=XXX) or (bypass_DF=<some_spar_df>) or (bypass_FN=<some_spar_filename>)
param_reduc <- param_reduc %>% pivot_longer(cols = param_reduc %>% select(-date, -geoid) %>% colnames(), names_to = 'parameter')

param_reduc %>% filter(parameter=='r0') %>% ggplot(aes(x=date, y=value)) + geom_line() + facet_wrap(~geoid)
```


```{r,  fig.show=TRUE}
param_reduc %>% filter(parameter=='nu1age18to64') %>% ggplot(aes(x=date, y=value)) + geom_path() + facet_wrap(~ geoid)
````

## Get compartment graph image

```{r}
gempyor_simulator$plot_transition_graph(output_file="full_graph")
gempyor_simulator$plot_transition_graph(output_file="readable_graph", 
                                        source_filters= list(list("age0to17"), list("OMICRON", "WILD")), 
                                        destination_filters= list(list("OMICRON", "WILD")))

```
here if source_filters is [["age0to17"], ["OMICRON", "WILD"]], it means filter (keep) all transitions that have as source: age0to17 AND (OMICRON OR WILD).

![full_graph look like this, scroll to the left to see that it's too big indeed](./full_graph.pdf){width=100% height=200}

![while readable_graph look like this](./readable_graph.pdf){width=100% height=200}



###Â Simulate

These functions take as input a `seed` file with sim_id `sim_id2write`, and outputs files hpar, spar, snpi, hnpi, seir, hosp with sim_id `sim_id2write`. In case the flag load_ID is set as true, the function will also load from file the parameters and the NPIs (hnpi, snpi, hpar, spar) from the simulation with sim_id `sim_id2load`

```{r}
gempyor_simulator$one_simulation(sim_id2write=0)
gempyor_simulator$one_simulation(sim_id2write=1, load_ID=TRUE, sim_id2load=0)
```

An additional method is provided to update the prefix, which is done by e.g filter_mc_MC.R
```{r}
gempyor_simulator$update_prefix(new_prefix="my new prefix")
```

### Little redudant example:

```{r,  fig.show=TRUE}


param_reduc %>% filter(parameter=='nu1age18to64') %>% ggplot(aes(x=date, y=value)) + geom_path() + facet_wrap(~ geoid)
````



## Installation
You need a working python3.7 installation with the gempyor the package dependencies installed.
```
 numba >=0.53.1
 pandas
 numpy
 seaborn
 tqdm
 matplotlib
 seaborn
 click
 confuse
 pyarrow
 sympy
 dask
 pytest ## only to run test
 scipy
 graphviz
```

### Normal python
This command will install the package and all it's dependencies (the `-e` makes so that when you pull the pipeline again, there is no need for re-installing)
```
pip install -e gempyor_pkg/
```
If the dependencies are already there and you don't want to risk to update them because of other python project, do
```
pip install --no-deps -e gempyor_pkg/
```


### python in the docker
```
/home/app/python_venv/bin/python3.7 -m pip install --upgrade pip # needs new pip for toml file
pip install  -e gempyor_pkg/
```

### Conda (simple)
If you use conda, let's create a conda enviroment with the versions
```
conda create -n covidSProd6 python=3.7
conda activate covidSProd6
conda install -c conda-forge jupyterlab ipykernel  dask click confuse matplotlib numba">=0.53" numpy pandas pyarrow pytest scipy seaborn sympy tqdm python-graphviz
pip install --no-deps -e gempyor_pkg/
```

### Conda (complicated)
This conda environment allows you to run both the R and the python code. It is not recommened except to run on HPCs.
```
conda create -n covidSProd6 -c conda-forge python jupyterlab ipykernel dask graphviz fastparquet click confuse matplotlib networkx numba">=0.53" numpy pandas pyarrow pytest scipy seaborn sympy  tqdm r-essentials python-graphviz
conda activate covidSProd6
python -m ipykernel install --user --name covidSProd6 --display-name "Python (covidSProd6)"
export R_PROFILE=$COVID_PATH/slurm_batch/Rprofile
conda install r-devtools  r-gridExtra r-ggfortify r-flextable r-doparallel r-reticulate r-truncnorm r-arrow
conda install r-tigris
conda install r-tidycensus r-optparse
conda env export --from-history > environment_cross.yml
conda env export > environment.yml
```


