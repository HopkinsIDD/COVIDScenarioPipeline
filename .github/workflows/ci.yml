name: unit-tests

on:
  push:
    branches:
      - master
      - dev
      - dataseed
      - inference
  pull_request:
    branches:
      - master
      - dev
      - dataseed
      - inference
      - inference_state
      - compartment_dev
      - seir-integration

jobs:
  unit-tests:
    runs-on: ubuntu-18.04
    container:
      image: docker://hopkinsidd/covidscenariopipeline:latest-dev
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Rprofile
        run: cp Docker.Rprofile $HOME/.Rprofile
        shell: bash
      - name: Set up Rprofile
        run: cp -r /home/app/.pyenv $HOME/.pyenv
        shell: bash
      - name: Install the gempyor package
        run: |
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          python -m pip install --upgrade pip
          pip install -e gempyor_pkg/
        shell: bash
      - name: Install local R packages
        run: Rscript local_install.R
        shell: bash
      - name: Run gempyor tests
        run: |
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          cd gempyor_pkg
          pytest -s
        shell: bash
      - name: Run covidcommon tests
        run: |
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          setwd("R/pkgs/covidcommon")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run hospitalization tests
        run: |
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          setwd("R/pkgs/hospitalization")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
#      - name: Run report.generation tests
#        run: |
#          setwd("R/pkgs/report.generation")
#          devtools::test(stop_on_failure=TRUE)
#        shell: Rscript {0}
      - name: Run inference tests
        run: |
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          setwd("R/pkgs/inference")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run integration tests
        env:
          CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
        run: |
          git lfs pull
          Rscript local_install.R
          cd test
          export PATH=/root/.pyenv/bin/:/root/.pyenv/plugins/pyenv-virtualenv/bin/:$PATH
          source /home/app/.bashrc
          pytest run_tests.py
        shell: bash
