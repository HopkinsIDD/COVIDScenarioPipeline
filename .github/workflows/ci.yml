name: unit-tests

on:
  push:
    branches:
      - master
      - dev
      - dataseed
      - inference
  pull_request:
    branches:
      - master
      - dev
      - dataseed
      - inference
      - inference_state

jobs:
  unit-tests:
    runs-on: ubuntu-18.04
    container:
      image: docker://hopkinsidd/covidscenariopipeline:latest-dev
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Rprofile
        run: cp Docker.Rprofile $HOME/.Rprofile
        shell: bash
      - name: Install SEIR and Outcomes packages
        run: |
          /home/app/python_venv/bin/pip install numba==0.53.1
          /home/app/python_venv/bin/python setup.py install
        shell: bash
      - name: Install local R packages
        run: Rscript local_install.R
        shell: bash
      - name: Run pytest SEIR
        run: |
          cd SEIR/test
          /home/app/python_venv/bin/pytest
        shell: bash
      - name: Run pytest Outcomes
        run: |
          cd Outcomes/test
          /home/app/python_venv/bin/pytest
        shell: bash
      - name: Run covidcommon tests
        run: |
          setwd("R/pkgs/covidcommon")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run hospitalization tests
        run: |
          setwd("R/pkgs/hospitalization")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run report.generation tests
        run: |
          setwd("R/pkgs/report.generation")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run inference tests
        run: |
          setwd("R/pkgs/inference")
          devtools::test(stop_on_failure=TRUE)
        shell: Rscript {0}
      - name: Run integration tests
        env:
          CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
        run: |
          git lfs pull
          Rscript local_install.R
          cd test
          /home/app/python_venv/bin/pytest run_tests.py
        shell: bash
