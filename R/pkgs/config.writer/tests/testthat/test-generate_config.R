generate_config <- function(){
    interventions <- readr::read_csv("processed_intervention_data.csv")
    
    config_name <- file.path(tempdir(), "config_test.yml")
    
    sink(config_name)
    
    print_header(sim_name = "USA",
                 sim_start_date = "2020-01-01",
                 sim_end_date = "2021-08-07",
                 n_simulations = 300,
                 sim_states = unique(interventions$USPS[!interventions$USPS %in% c("", "all") & !is.na(interventions$USPS)]),
                 setup_name = "usa_inference_territories_statelevel",
                 geodata = "geodata_territories_2019_statelevel.csv",
                 mobility = "mobility_territories_2011-2015_statelevel.csv")
    
    print_seeding(lambda_file = "data/minimal/seeding_territories.csv",
                  perturbation_sd = 3)
    
    print_seir(gamma_dist = "uniform",
               gamma_a = 1/4.5, 
               gamma_b = 1/3,
               R0s_dist = "fixed",
               R0s_val = 2.3,
               incl_vacc = TRUE,
               dose_susceptibility_val = c(0, 0.5, 0.90),
               transitions_val = c(0, 0.04))
    
    print_transmission_interventions(interventions,
                                     scenario = "inference")
    
    print_outcomes(dat = interventions,
                   ifr = "med",
                   outcomes_parquet_file="usa-geoid-params-output_statelevel.parquet", 
                   incidC_prob_mean = 0.4)
    
    print_filtering(sims_per_slot = 1500)
    
    print_hierarchical(npi_name = c("local_variance", "probability_incidI_incidC"),
                       module = c("seir", "hospitalization"),
                       geo_group_col = "USPS",
                       transform = c("none", "logit"))
    
    print_prior(dat = interventions,
                npi_name = c("local_variance", "Seas_jan", "Seas_feb", "Seas_mar",
                             "Seas_may", "Seas_jun", "Seas_jul", "Seas_aug", "Seas_sep",
                             "Seas_oct", "Seas_nov", "Seas_dec"))
    
    sink()
    
    config <- yaml::read_yaml(config_name)
    
    unlink(config_name)
    
    return(config)
}


test_that("Config generation works", {
    test_config <- generate_config()
    config <- yaml::read_yaml("sample_config.yml")
    
    expect_equal(
        test_config, 
        config
    )

})

