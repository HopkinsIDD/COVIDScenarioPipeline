---
title: "Sanity Check and Data Compare"
output: 
  html_document: 
    theme: journal
    fig_caption: true
params: 
  config_file: "config.yml"
---

```{r setup, include=FALSE}
library(covidImportation)
library(report.generation)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "../../..")
```

```{r load_config}
config <- covidcommon::load_config(params$config_file)

geodata <- load_geodata_file(file.path(config$spatial_setup$base_path, config$spatial_setup$geodata),
                             geoid_len=5)
```

```{r config_vals}
scn_dir <- paste(config$name,config$interventions$scenarios[1],sep='_') # sanity check on first scenario only

run <- as.character(config$sanity$run) # either state, states/region or country
# run <- case_when(length(config$report$state_usps)==1 ~ "state", 
#                  is.null(config$report$state_usps) ~ "country")

modeled_country <- "US" # can be modified if we add config$sanity$country
# modeled_country <- c(as.character(config$sanity$country))


# modeled_states <- case_when(modeled_country == "USA" ~ state.name,
#                             run=="state" ~ state.name[which(state.abb %in% config$report$state_usps)])
                            #run=="multi-state" ~ state.name[which(state.abb %in% config$spatial_setup$modeled_states)]

geogroup <- case_when(run=="state" ~ "geoid",
                      run=="country" ~ "USPS")

key_group <- config$report$key_group # would need to be added
tab_counter <- 1
fig_counter <- 1
```
##Summarize Run Parameters

`r paste0("**Tab.", tab_counter, "**: Summary of hospitalization parameters")`

```{r param_summary}
tbl_names <- list()
tbl_sections <- list() 
tbl_values <- list() 

for(i in 1:length(config$hospitalization)){
    tbl_names[[i]] <- names(config$hospitalization[[i]])
    tbl_sections[[i]] <- config$hospitalization[i] %>% names() %>% rep(., length(tbl_names[[i]])) 
    tbl_values[[i]] <- unlist(config$hospitalization[[i]])
}


tbl_names <- unlist(tbl_names, use.names = FALSE)
tbl_sections <- unlist(tbl_sections, use.names = FALSE)
tbl_values <- unlist(tbl_values)
tbl_values <- tbl_values %>%
    tibble(as_tibble(.), names = names(.)) %>%
    mutate(names = str_remove(names, '\\d$')) %>%
    group_by(names) %>%
    summarise_all(funs(paste0(.,collapse=', '))) %>%
    select(-.)
param_tbl <- tibble(section = tbl_sections, names = tbl_names) %>%
    left_join(tbl_values, by = "names") %>%
    mutate(config = "hospitalization")


tbl_names <- list()
tbl_sections <- list() 
tbl_values <- list() 

for(i in 1:length(config$seir)){
    tbl_names[[i]] <- names(config$seir[[i]])
    tbl_sections[[i]] <- config$seir[i] %>% names() %>% rep(., length(tbl_names[[i]])) 
    tbl_values[[i]] <- unlist(config$seir[[i]])
}

tbl_names <- unlist(tbl_names, use.names = FALSE)
tbl_sections <- unlist(tbl_sections, use.names = FALSE)
tbl_values <- unlist(tbl_values)
tbl_values <- tbl_values %>%
    tibble(as_tibble(.), names = names(.)) %>%
    mutate(names = str_remove(names, '\\d$')) %>%
    separate(names, into = c("names", "val"), sep = "\\.") %>%
    select(names, val, value) %>%
    unite(value, val:value, sep=": ", na.rm=TRUE) %>%
    group_by(names) %>%
    summarise_all(funs(paste0(.,collapse='\n'))) 

param_tbl <- tibble(section = tbl_sections, names = tbl_names) %>%
    left_join(tbl_values, by = "names") %>%
    mutate(config = "seir") %>%
    bind_rows(param_tbl)

param_tbl %>%
    filter(section == "parameters") %>%
    select(config, names, value) %>%
    flextable::flextable() %>%
    flextable::merge_v(j="config") %>%
    flextable::autofit() %>%
    flextable::theme_vanilla()

tab_counter <- tab_counter+1
```

`r paste0("**Tab.", tab_counter, "**: Scenario summary")`

````{r}
scen <- config$interventions$scenarios
set <- names(config$interventions$settings)

scenario_tbl <- list()
for(i in 1:length(config$interventions$settings[which(set %in% scen)])){
    scenario_tbl[[i]] <- tibble(intervention = config$interventions$settings[which(set %in% scen)][[i]]$scenarios) %>%
        mutate(scenario = names(config$interventions$settings[which(set %in% scen)][i]))
}


scenario_tbl2 <- list()
for(i in 1:length(config$interventions$settings[which(!set %in% scen)])){
scenario_tbl2[[i]]    <- unlist(config$interventions$settings[which(!set %in% scen)][[i]]) %>%
        tibble(as_tibble(.), names = names(.)) %>%
        separate(names, into = c("names", "val"), sep = '\\.') %>%
        select(names, val, value) %>%
        unite(value, val:value, sep=": ", na.rm = TRUE) %>%
        group_by(names) %>%
        summarise_all(funs(paste0(.,collapse='\n'))) %>%
        mutate(intervention = names(config$interventions$settings[which(!set %in% scen)][i])) 
}

bind_rows(scenario_tbl2) %>%
    inner_join(bind_rows(scenario_tbl), by = "intervention") %>%
    arrange(scenario) %>%
    filter(names != "template") %>%
    select(Scenario = scenario, Intervention = intervention, Parameters = names, Value = value) %>%
    flextable::flextable() %>%
    flextable::merge_v(j = "Scenario") %>%
    flextable::merge_v(j="Intervention") %>%
    flextable::autofit() %>%
    flextable::theme_box()

```

## Comparisons with JHU csse

```{r JHU_case_load}

# geodata <- read_csv("data/geodata.csv")
# Download jhu_csse data allowing for non-US country

jhu_data_dir = "JHU_CSSE_Data" #check

  if(!dir.exists(jhu_data_dir)) {
    ### Download JHU data
    pull_JHUCSSE_github_data(jhu_data_dir)
  } else {
    ### Get updated version
    covidImportation:::update_JHUCSSE_github_data(jhu_data_dir)
  }

  ### Read in JHU data
  jhu_CSSE_dat <- read_JHUCSSE_cases(case_data_dir = jhu_data_dir)
  
# ##TEMPORARY LOADING WHILE GITHUB IS DOWN
# jhu_CSSE_deaths <- read_csv("tmp/jhucsse_death_data_crude.csv")
# jhu_CSSE_cases <- read_csv("tmp/jhucsse_case_data_crude.csv")
# # 
# jhu_CSSE_deaths <- jhu_CSSE_deaths%>%
#   select(Update,FIPS, Country_Region,Province_State, Deaths)
# 
# jhu_CSSE_cases <- jhu_CSSE_cases%>%
#   select(Update,FIPS, Country_Region,Province_State, Confirmed)
# 
# jhu_CSSE_dat <- inner_join(jhu_CSSE_cases,jhu_CSSE_deaths)

  jhu_CSSE_dat <- 
    jhu_CSSE_dat %>%
    dplyr::mutate(date = as.Date(Update)) %>%
    dplyr::filter(Country_Region %in% modeled_country) %>%
    dplyr::mutate(USPS = cdlTools::fips(str_replace_all(Province_State," ", ""),to="abbreviation"))    %>%     
    {if(run=="state") dplyr::filter(., USPS == config$sanity$usps) else(.)} %>%
    {if(run=="state") group_by(., date, FIPS, Admin2) else(group_by(., date, USPS))} %>%
    dplyr::summarize(cumConfirmed = sum(Confirmed), cumDeaths = sum(Deaths, na.rm = TRUE)) %>%
    ungroup() %>%
    dplyr::arrange(date) %>%
    {if(run=="state") dplyr::mutate(., FIPS = if_else(str_length(FIPS)==4, gsub('^', '0', FIPS), FIPS)) else(.)} %>%
    {if(run=="state") rename(., geoid=FIPS) else(rename(.))} %>%
    drop_na()
  
  # if(run == "country") {
  # jhu_CSSE_dat <- 
  #   jhu_CSSE_dat %>%
  #   dplyr::mutate(date = as.Date(Update)) %>%
  #   dplyr::filter(Country_Region %in% modeled_county) %>%
  #   dplyr::mutate(USPS = cdlTools::fips(str_replace_all(Province_State," ", ""),to="abbreviation")) %>% 
  #   group_by(date, USPS) %>%
  #   dplyr::summarize(cumConfirmed = sum(Confirmed), cumDeaths = sum(Deaths, na.rm = TRUE)) %>%
  #   ungroup() %>%
  #   dplyr::arrange(date) %>%
  #   drop_na()
  # } else {
  #   jhu_CSSE_dat <- 
  #   jhu_CSSE_dat %>%
  #   dplyr::mutate(date = as.Date(Update)) %>%
  #   dplyr::filter(Country_Region %in% modeled_country) %>%
  #   dplyr::mutate(USPS = cdlTools::fips(str_replace_all(Province_State," ", ""),to="abbreviation")) %>% 
  #   dplyr::filter(Province_State %in% config$report$state_usps) %>%
  #   group_by(date, USPS) %>%
  #   dplyr::summarize(cumConfirmed = sum(Confirmed), cumDeaths = sum(Deaths, na.rm = TRUE)) %>%
  #   ungroup() %>%
  #   dplyr::arrange(date) %>%
  #   drop_na()
  # }
```

```{r model_res_load}
# geodata <- read_csv("data/geodata.csv")
doParallel::registerDoParallel(28)

post_proc <- function(x,geodata, geogroup) {
    
  x%>%
    group_by(geoid) %>%
    mutate(cum_hosp=cumsum(incidH)) %>%
    mutate(cum_death=cumsum(incidD)) %>%
    ungroup()%>%
    #filter(time%in%lubridate::as_date(Sys.Date())) %>% 
    inner_join(geodata%>%select(geoid, USPS)) %>%
    group_by(!!as.symbol(geogroup), time) %>%
    summarize(hosp_curr=sum(hosp_curr), cum_hosp=sum(cum_hosp),
              cum_death=sum(cum_death), 
              incidD=sum(incidD),
              incidI=sum(incidI)) %>%
    ungroup()
  }

res_state <- list()

nfiles <-  100
pdeath_levels <- c("high","med","low")
for (i in 1:length(pdeath_levels)){
  
 res_state[[i]] <- load_hosp_sims_filtered(scn_dir,
                               name_filter = pdeath_levels[i],
                               num_files = nfiles,
                               post_process = post_proc,
                               geodata=geodata,
                               geogroup=geogroup) %>%
   group_by(time, !!as.symbol(geogroup)) %>%
   summarize(cum_death_5pct=quantile(cum_death,probs=.05),
             cum_death_95pct=quantile(cum_death,probs=.95),
             cum_hosp_5pct=quantile(cum_hosp,probs=.05),
             cum_hosp_95pct=quantile(cum_hosp,probs=.95),
             hosp_curr=round(mean(hosp_curr)),
             cum_hosp=round(mean(cum_hosp)), 
             cum_death=round(mean(cum_death)),
             incidD=mean(incidD),
             incidI=mean(incidI)) %>%
  mutate(death_Rate=pdeath_levels[i]) %>%
  mutate(scenario=scn_dir) %>%
   ungroup()
 
 
 res_state[[i+length(pdeath_levels)]] <- load_hosp_sims_filtered(scn_dir,
                               name_filter = pdeath_levels[i],
                               num_files = nfiles,
                               post_process = post_proc,
                               geodata=geodata,
                               geogroup=geogroup) %>%
   group_by(time, !!as.symbol(geogroup)) %>%
   summarize(hosp_curr=round(mean(hosp_curr)), 
             cum_hosp_5pct=quantile(cum_hosp,probs=.05),
             cum_hosp_95pct=quantile(cum_hosp,probs=.95),
             cum_death_5pct=quantile(cum_death,probs=.05),
             cum_death_95pct=quantile(cum_death,probs=.95),
             cum_hosp=round(mean(cum_hosp)), 
             cum_death=round(mean(cum_death)),
             incidD=mean(incidD),
             incidI=mean(incidI)) %>%
  mutate(death_Rate=pdeath_levels[i]) %>%
  mutate(scenario=scn_dir)%>%
   ungroup()
 
 
 # res_state[[i+2*length(pdeath_levels)]] <- load_hosp_sims_filtered("USA_local_variance_Lockdown1918_firstcase_10x_300_per_slot",
 #                               name_filter = pdeath_levels[i],
 #                               num_files = nfiles,
 #                               post_process = post_proc,
 #                               geodata=geodata) %>%
 #  group_by(time,USPS) %>%
 #   summarize(hosp_curr=round(mean(hosp_curr)),
 #             cum_hosp_5pct=quantile(cum_hosp,probs=.05),
 #             cum_hosp_95pct=quantile(cum_hosp,probs=.95),
 #             cum_death_5pct=quantile(cum_death,probs=.05),
 #             cum_death_95pct=quantile(cum_death,probs=.95),
 #             cum_hosp=round(mean(cum_hosp)),
 #             cum_death=round(mean(cum_death)),
 #             incidD=mean(incidD),
 #             incidI=mean(incidI)) %>%
 #  mutate(death_Rate=pdeath_levels[i]) %>%
 #  mutate(scenario="USA_local_variance_Lockdown1918_firstcase_10x_300_per_slot")%>%
 #   ungroup()
}



res_state <- dplyr::bind_rows(res_state)

doParallel::stopImplicitCluster()
```

### Check 1: Deaths vs. National/State Report

Comparison of deaths to national and state level trends as of the report date



```{r mdl_v_ob_death, fig.cap= cap}

res_state <- res_state %>% mutate(death_Rate=factor(death_Rate, levels=c("low","med","high"), ordered=T)) 
res_state%>%
  group_by(scenario, death_Rate, !!as.symbol(geogroup)) %>%
  #{if(run=="state") group_by(., scenario, death_Rate, geoid) else(group_by(.,scenario, death_Rate, USPS))} %>%
  # group_by(scenario,death_Rate,USPS)%>%
  mutate(lead_death=lead(cum_death,14))%>%
  ungroup%>%
  filter(time==max(jhu_CSSE_dat$date))%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date)) %>% # by = c("time", geogroup)) %>% #{if(run=="state") c("time", "geoid"="FIPS") else(c("time", "USPS"))}) %>%
  ggplot(aes(x=cumDeaths, y=cum_death, col=death_Rate, label = {if(run=="state") Admin2 else(USPS)})) +
  geom_text() +
  scale_y_sqrt()+
  scale_x_sqrt()+
  geom_abline()+
  facet_wrap(~scenario+death_Rate, nrow=2) +
  theme_bw() +
  theme(legend.position = "none")+
  xlab("observed deaths") +
  ylab("modeled deaths")
  
cap <- paste0("Modeled deaths vs. observed deaths", 
              if_else(run=="country", " by state", " by county"))

##Useful sanity check
# res_state%>%filter(time==max(jhu_CSSE_dat$date))%>%
#   inner_join(jhu_CSSE_dat%>%rename(time=date)) %>%
#   ggplot(aes(x=cumDeaths, y=cum_hosp*.1, col=death_Rate, label=USPS)) +
#   geom_text() +
#   scale_y_sqrt()+
#   scale_x_sqrt()+
#   geom_abline()+
#   facet_wrap(~scenario+death_Rate, nrow=3) +
#   theme_bw() +
#   theme(legend.position = "bottom")
  

```
```{r death_comp_bars, fig.height=10, fig.width=6}

## Looking at the deaths in a different way...comparing bar graphs.

#res_state <- res_state %>% mutate(death_Rate=factor(death_Rate, #levels=c("low","med","high"), ordered=T)) 

res_state%>%
  group_by(scenario, death_Rate, !!as.symbol(geogroup)) %>%
  mutate(lead_death=lead(cum_death,14))%>%
  ungroup%>%
  filter(time==max(jhu_CSSE_dat$date))%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date)) %>%
  select(time, !!as.symbol(geogroup), cum_death, cumDeaths, scenario, death_Rate)%>%
  rename(observed=cumDeaths, modeled=cum_death)%>%
  pivot_longer(c(-time, -!!as.symbol(geogroup), -scenario, -death_Rate),
               names_to="source", values_to = "deaths") %>%
  filter(death_Rate=="low")%>%
  filter(scenario==scn_dir)%>%
  {if(run=="state") left_join(.,jhu_CSSE_dat %>% select(geoid, time=date, Admin2)) else(.)} %>%
  ggplot(aes(x= {if(run=="state") Admin2 else(!!as.symbol(geogroup))}, y=deaths, fill=source))+
  geom_bar(stat="identity",position=position_dodge()) +
  coord_flip() +
  scale_y_sqrt()+
  ggtitle("Low Death Rate, Effective Intervention")
```



```{r}
  mapdat <-res_state%>%
  filter(death_Rate=="low")%>%
  filter(scenario==scn_dir)%>%
  filter(time==max(jhu_CSSE_dat$date))%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date)) %>%
  {if(run=="state") rename(., fips = geoid, full=Admin2)  
    else (mutate(., full=cdlTools::fips(USPS, to="Name"), fips=cdlTools::fips(USPS, to="FIPS")))} %>%
  mutate(death_ratio=cum_death/cumDeaths)%>%
  #rename(abbr=!!as.symbol(geogroup))%>%
  select(fips,full, death_ratio)

  usmap::plot_usmap(data=mapdat, values="death_ratio", include = unlist(mapdat$fips, use.names=FALSE)) +
    scale_fill_gradient2(trans="log10",midpoint = 0, low="blue",high="red", limits=c(1/60,60),name="mod/obs")+
    ggtitle("Low Death Rate, Effective Intervention")

```

```{r}
## Look at ratio of cases to deaths to help think about possible biases in reporting

mapdat<- jhu_CSSE_dat %>%
  filter(date==max(jhu_CSSE_dat$date))%>%
  {if(run=="state") rename(., fips = geoid, full=Admin2)  
    else (mutate(., full=cdlTools::fips(USPS, to="Name"), fips=cdlTools::fips(USPS, to="FIPS")))} %>%
    # mutate(full=cdlTools::fips(USPS, to="Name"))%>%
    # mutate(fips=cdlTools::fips(USPS, to="FIPS"))%>%
    mutate(cfr=cumDeaths/cumConfirmed)%>%
    # rename(abbr=USPS)%>%
    select(fips,full, cfr)


  usmap::plot_usmap(data=mapdat, values="cfr", include = unlist(mapdat$fips, use.names=FALSE))+
    scale_fill_gradient(name="CFR", low="#ffeda0",high="#f03b20")+
    ggtitle(paste0("Observed CFR by ", if_else(run=="state", "county", "state"))) # check USPS for counties...

```


```{r mdl_v_ob_ts} 

res_state%>%  #group_by(scenario,death_Rate,USPS)%>%
  #mutate(cum_death=lead(cum_death,14),
  #       cum_death_5pct=lead(cum_death_5pct,14),
  #       cum_death_95pct=lead(cum_death_95pct, 14))%>%
  #ungroup%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
  group_by(time, scenario, death_Rate)%>%
  summarize(cum_death=sum(cum_death), cumDeaths=sum(cumDeaths),
            cum_death_5pct=sum(cum_death_5pct), 
            cum_death_95pct=sum(cum_death_95pct))%>%
  ungroup()%>%
  ggplot(aes(x=time, y=cum_death, ymin=cum_death_5pct, ymax=cum_death_95pct)) +
  geom_line(col="red")+
  geom_ribbon(alpha=.1)+
  geom_point(aes(y=cumDeaths)) +
  facet_wrap(~scenario+death_Rate, ncol=3)+
  scale_y_sqrt()+
  theme_bw()+
  ylab("deaths")

#need to add title
  

#Useful sanity check
# res_state%>%  inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
#   group_by(time, scenario, death_Rate)%>%
#   summarize(cum_death=sum(cum_hosp*.1,na.rm=T), cumDeaths=sum(cumDeaths),
#             cum_death_5pct=sum(cum_death_5pct),
#             cum_death_95pct=sum(cum_death_95pct))%>%
#   ungroup()%>%
#   ggplot(aes(x=time, y=cum_death, ymin=cum_death_5pct, ymax=cum_death_95pct)) +
#   geom_line(col="red")+
#   geom_ribbon(alpha=.1)+
#   geom_point(aes(y=cumDeaths)) +
#   facet_wrap(~scenario+death_Rate, nrow=3)+
#   scale_y_sqrt()
  
```

```{r}
## Comparison of cumulative curves by key states
# key_states <- c("IA","IL","IN","MI","MN","WI")
key_group <- sample(unlist(mapdat$fips, use.names=FALSE), 4)

res_state%>% # group_by(scenario,death_Rate,USPS)%>%
  #mutate(cum_death=lead(cum_death,14),
  #       cum_death_5pct=lead(cum_death_5pct,14),
  #       cum_death_95pct=lead(cum_death_95pct, 14))%>%
  #ungroup%>%
  filter(!!as.symbol(geogroup) %in% key_group, death_Rate=="high")%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
  {if(run=="state") rename(., group=Admin2) else(rename(.,group=!!as.symbol(geogroup)))} %>%
  ggplot(aes(x=time, y=cum_death, ymin=cum_death_5pct, ymax=cum_death_95pct, 
             color=scenario, fill=scenario)) +
  geom_line()+
  geom_ribbon(alpha=.25,color=NA)+
  geom_point(aes(y=cumDeaths), col="black") +
  facet_wrap(~ group, nrow=2)+
  scale_y_sqrt() +
  theme(legend.position = "bottom") +
  ylab("deaths") +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        )
  
```




### Check 2: Hospitalization vs Confirmed Cases (National/State)
```{r mdl_v_ob_hosp}

res_state%>%filter(time==max(jhu_CSSE_dat$date))%>%
  inner_join(jhu_CSSE_dat%>%rename(time=date)) %>%
  {if(run=="state") rename(., group=Admin2) else(rename(.,group=!!as.symbol(geogroup)))} %>%
  ggplot(aes(x=cumConfirmed, y=cum_hosp, col=death_Rate, label=group)) +
  geom_text() +
  scale_y_sqrt()+
  scale_x_sqrt()+
  geom_abline()+
  facet_wrap(~scenario+death_Rate, nrow=2) +
  theme_bw() +
  theme(legend.position = "none") +
  xlab("observed confirmed cases")+
  ylab("modeled hospitalizations")
  
  

```
```{r mdl_v_ob_ts_hosp} 

res_state%>%inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
  group_by(time, scenario, death_Rate)%>%
  summarize(cum_hosp=sum(cum_hosp),
            cumConfirmed=sum(cumConfirmed),
            cum_hosp_5pct=sum(cum_hosp_5pct), 
            cum_hosp_95pct=sum(cum_hosp_95pct))%>%
  ungroup()%>%
  ggplot(aes(x=time, y=cum_hosp, ymin=cum_hosp_5pct, ymax=cum_hosp_95pct)) +
  geom_line()+
  geom_ribbon(alpha=.1)+
  geom_point(aes(y=cumConfirmed)) +
  facet_wrap(~scenario+death_Rate, nrow=2)+
  theme_bw()+
  scale_y_sqrt()+
  ylab("hospitalizations")
  
```


## Compare Infections to Confirmed Cases with a Delay

```{r lagged_inc_compare}

res_state<-res_state%>%
  group_by(!!as.symbol(geogroup), death_Rate, scenario)%>%
  mutate(adjI = c(0,diff(cum_hosp))*5) %>%
  ungroup()

##Compare to confirmed cases at a national level
usa_sum <-res_state%>%inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
  #filter(death_Rate=="low")%>%
  group_by(scenario, death_Rate, time)%>%
  summarize(adjI=sum(adjI, na.rm = T), 
            cumConfirmed=sum(cumConfirmed)) %>%
  ungroup() %>%
  group_by(scenario, death_Rate)%>%
  arrange(time)%>%
  mutate(confirmed=c(0,diff(cumConfirmed)))%>%
  ungroup

 

usa_sum%>%ggplot(aes(x=time, y=adjI, color=scenario, linetype=death_Rate))+
  geom_line()+
  geom_point(aes(y=confirmed), color="black")+
  ylab("approximate cases")


```


```{r key_States}
# key_states <-  c("IA","NY","CA")

key_state_sum <-res_state%>%inner_join(jhu_CSSE_dat%>%rename(time=date))%>%
  filter(!!as.symbol(geogroup) %in% key_group)%>%
  {if(run=="state") rename(., group=Admin2) else(rename(.,group=!!as.symbol(geogroup)))} %>%
  group_by(scenario, death_Rate, group)%>%
  mutate(confirmed=c(0,diff(cumConfirmed)))%>%
  ungroup() 

key_state_sum%>%
  filter(scenario!="Uncontrolled")%>%
  ggplot(aes(x=time, y=adjI, color=scenario))+
  geom_line()+
  geom_point(aes(y=confirmed), color="black")+
  facet_wrap(~group+death_Rate, nrow=length(key_group)) +
  scale_y_sqrt()+
  theme_bw()+
  theme(legend.position = "bottom")+
  ylab("approximate cases")
```




## Diagnostics on Various Model Parameters


### Hospitalizations and Deaths

```{r}

res_state%>% 
  mutate(death_hosp_ratio = cum_death/cum_hosp)%>%
  ggplot(aes(x=time, y=death_hosp_ratio, color=scenario)) +
    geom_point(alpha=.01) +
    geom_hline(yintercept=.1)



res_state%>% 
  group_by(!!as.symbol(geogroup), scenario) %>% 
  mutate(lead_death=lead(cum_death,3)) %>%
  ungroup() %>%
  mutate(death_hosp_ratio = lead_death/cum_hosp)%>%
  ggplot(aes(x=time, y=death_hosp_ratio, color=scenario)) +
    geom_point(alpha=.01) +
    geom_hline(yintercept=.1)

```