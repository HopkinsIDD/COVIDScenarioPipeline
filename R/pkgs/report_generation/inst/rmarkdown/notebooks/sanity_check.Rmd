---
title: "Sanity Check and Data Compare"
output: 
  html_document: 
    theme: journal
    fig_caption: true
params: 
  config_file: config_inference_ca_high_report.yml # add sanity: with run ("country" or "state"), country (e.g. "US"),  state (if run=="state"), and inference (T/F)
---

```{r setup, include=FALSE}
library(covidcommon)
library(report.generation)
library(tidyverse)
library(cdlTools)
library(doParallel)

knitr::opts_chunk$set(
    echo = FALSE,
    fig.align = "center",
    message = FALSE,
    warning = FALSE,
    cache.lazy = FALSE,
    bitmapType = "cairo"
    )

knitr::opts_knit$set(eval.after = 'fig.cap', 
                     root.dir = "../..") # assumes in notebook subdirectory

options(scipen=999)
```

```{r load_config}
config <- covidcommon::load_config(params$config_file)

run_folder<- "runs_20200618" #name of folder for open_dataset

geodata <- load_geodata_file(file.path(paste0(config$spatial_setup$base_path, "/", config$spatial_setup$geodata)),
                             geoid_len=5)

shp <- rgdal::readOGR(paste0(config$spatial_setup$base_path, "/", config$spatial_setup$setup_name,  "/", str_remove(config$spatial_setup$shapefile, "\\/.+$")), str_remove(str_remove(config$spatial_setup$shapefile, "^.+\\/"), ".shp")) # update to new shp file location 

geo_names <- load_shape_file(filename = file.path(paste0(config$spatial_setup$base_path,"/", config$spatial_setup$setup_name, "/", config$spatial_setup$shapefile_name)), #update as well
                       to_lower = TRUE,
                       geoid_len = 5)

```

```{r setup_config_vals}
forecast_start<-Sys.Date()-14 # CHECK: serves as cut-off for reported data as well
hosp_eval <- FALSE # CHECK: is there hospitalization data? currently works for state only, currently have to specify where it's downloaded

run <- as.character(config$sanity$run) # either state, states/region or country
country <- "US" 
state <- {if(run=="state") config$sanity$state else(config$spatial_setup$modeled_states)} 
geogroup <- case_when(run=="state" ~ "geoid",
                      run=="country" ~ "USPS")

included_geoids <- geodata %>%
  filter(USPS %in% {if(run=="state") config$sanity$state else(config$spatial_setup$modeled_states)}) %>%
  dplyr::select(!!as.symbol(geogroup)) %>%
  distinct() %>%
  unlist(use.names = FALSE)

infer <- exists("filtering", where = config) ## is there inference in the runs?
nfiles <-  NA 
pdeath_levels <- c("high", "med", "low") #can also specify with config$hospitalization$parameters$p_death_names

t_report <- 14 # time between deaths and reporting
pi_lo<-0.05
pi_hi<-0.95
tab_counter <- 1
fig_counter <- 1
```

```{r setup_params, eval=infer}
geo_names <- geo_names %>% 
  sf::st_drop_geometry() %>% 
  mutate(statefp = as.numeric(as.character(statefp)),
         USPS = cdlTools::fips(as.numeric(statefp), to = "Abbreviation")) %>%
  dplyr::select(geoid, name, USPS) %>% 
  filter({if(run=="state") geoid else(USPS)} %in% included_geoids) %>% 
  distinct() %>%
  tibble()

npi_names<- names(config$interventions$settings[unlist(lapply(config$interventions$settings, exists, x="perturbation"))]) 

npi_label <- NA

if(is.na(npi_label)){
    label <- tibble(npi_label = npi_names,
                    npi_name = npi_names)
} else {
    label <- tibble(npi_label,
                    npi_name = npi_names)
}

```

## Summarize Run Parameters  

`r paste0("**Tab.", tab_counter, "**: Summary of hospitalization and SEIR parameters")`
```{r param_summary, eval=FALSE}

hosp <- config$hospitalization$parameters

hosp <- tibble(value = unlist(hosp), names = names(unlist(hosp))) %>%
    mutate(names = str_remove(names, '\\d$')) %>%
    group_by(names) %>%
    summarise_all(funs(paste0(.,collapse=', '))) %>%
    right_join(hosp%>%names()%>%tibble(names=.)) %>%
    mutate(section = "Hospitalization")

seir <- config$seir$parameters

seir <- tibble(value = unlist(seir), names = names(unlist(seir))) %>%
    separate(names, into = c("names", "val"), sep = "\\.") %>%
    select(names, val, value) %>%
    unite(value, val:value, sep=": ", na.rm=TRUE) %>%
    group_by(names) %>%
    summarise_all(funs(paste0(.,collapse='\n'))) %>%
    right_join(seir%>%names()%>%tibble(names=.)) %>%
    mutate(section= "SEIR") 

import <- config$importation

if(!is.null(import)) {
importation <- tibble(value = unlist(import), names = names(unlist(import))) %>%
  select(-census_api_key, cache_work, update_case_data, print_progress) %>% 
  mutate(section = "Importation")

import <- config$importation$param_list

importation <- tibble(value = unlist(import), names = names(unlist(import))) %>%
  mutate(names = str_remove(names, '\\d$')) %>%
  group_by(names) %>%
  summarise_all(funs(paste0(.,collapse=', '))) %>%
  right_join(import%>%names()%>%tibble(names=.)) %>%
  mutate(section = "Importation") %>%
  bind_rows(importation, .)
}

hosp %>%
  {if(is.null(import)) bind_rows(., seir) else(bind_rows(., seir, importation))} %>%
    select(Section = section, Parameters = names, Value = value) %>%
    flextable::flextable() %>%
    flextable::merge_v(j="Section") %>%
    flextable::autofit() %>%
    flextable::theme_vanilla()

tab_counter <- tab_counter+1
```

`r if_else(run=="state", paste0("**Tab.", tab_counter, "**: Scenario summary"),"")` 
````{r scen_summary, eval = FALSE}

cap<-paste0("**Tab.", tab_counter, "**: Scenario summary")

scen <- config$interventions$scenarios
set <- names(config$interventions$settings)
scenarios <- config$interventions$settings[which(set %in% scen)]
interventions <- config$interventions$settings[which(!set %in% scen)]

scenario_tbl <- list()
for(i in 1:length(scenarios)){
    scenario_tbl[[i]] <- tibble(intervention = scenarios[[i]]$scenarios) %>%
        mutate(scenario = names(scenarios[i]))
}

scenario_tbl2 <- list()
for(i in 1:length(interventions)){
    scenario_tbl2[[i]]    <- unlist(interventions[[i]]) %>%
        tibble(as_tibble(.), names = names(.)) %>%
        separate(names, into = c("names", "val"), sep = '\\.') %>%
        select(names, val, value) %>%
        unite(value, val:value, sep=": ", na.rm = TRUE) %>%
        group_by(names) %>%
        summarise_all(funs(paste0(.,collapse='\n'))) %>%
        mutate(intervention = names(config$interventions$settings[which(!set %in% scen)][i])) 
}

scenario_times <- list()
for(i in 1:length(interventions)){
  scenario_times[[i]] <- tibble(time = paste0(interventions[[i]]$period_start_date, " to \n", interventions[[i]]$period_end_date), intervention = names(interventions)[i])
}

bind_rows(scenario_tbl2) %>%
  filter(names!="period_end_date" & names!="period_start_date" & names!="template") %>%
    inner_join(bind_rows(scenario_tbl), by = "intervention") %>%
    inner_join(bind_rows(scenario_times), by = "intervention") %>%
    arrange(scenario) %>%
    select(Scenario=scenario, Intervention=intervention, `Start-End Period`=time, Parameters=names, `R0`=value) %>%
    flextable::flextable() %>%
    flextable::merge_v(j = "Scenario") %>%
    flextable::merge_v(j="Intervention") %>%
    flextable::autofit() %>%
    flextable::theme_box()

tab_counter <- tab_counter + 1
```

```{r r_load, eval=infer}

inference_r <- arrow::open_dataset(paste0(run_folder,"/spar/"), 
                    partitioning = c("location", "scenario", "death_rate", "date", "lik_type", "is_final", "sim_id")) %>%
    collect() %>%             
    filter(parameter=="R0") %>%
    group_by(death_rate, scenario)%>%
    mutate(sim_id_num = order(sim_id)) %>%
    group_by(sim_id_num, scenario)%>%
    summarize(value=mean(value)) %>%
    mutate(parameter = "r0") %>%
    rename(state_r0 = value) %>%
    right_join(arrow::open_dataset(paste0(run_folder,"/snpi/"), 
                                   partitioning = c("location", "scenario", "death_rate", "date", "lik_type", "is_final", "sim_id")) %>%
                   collect() %>%
                   group_by(death_rate, geoid, npi_name, scenario)%>%
                   mutate(sim_num = order(sim_id)) %>%
                   group_by(sim_num, scenario, geoid, npi_name, parameter, start_date, end_date)%>%
                   summarize(reduction=mean(reduction))
    )

inference_r <- inference_r %>%
          filter(npi_name=="local_variance") %>%
          mutate(county_r0 = state_r0*(1-reduction)) %>%
          select(geoid, sim_num, county_r0, scenario) %>%
          left_join(inference_r %>% filter(npi_name %in% npi_names)) %>%
          mutate(r_eff = if_else(npi_name=="local_variance",
                                 county_r0,
                                 county_r0*(1-reduction))) %>%
          group_by(geoid, npi_name) %>%
          summarize(r = mean(r_eff), 
                    rq1 = quantile(r_eff, 0.25), 
                    rq3 = quantile(r_eff, 0.75),
                    lower=quantile(r_eff, 0.025),
                    upper=quantile(r_eff,0.975),
                    reduc = mean(reduction), 
                    reducq1 = quantile(reduction, 0.25), 
                    reducq3 = quantile(reduction, 0.75))
```

```{r reproductive_num, fig.height = 10, eval=infer, fig.cap=cap}

cap<-paste0("**Fig.", fig_counter, "**: Estimated reproducive number at baseline and during previous interventions")
  
plot_r_num <- function(inference_dat, 
                       npiselection = npi_names,
                       npilabel = NA, 
                       periodcolors = c("chartreuse3", "brown2", "turquoise4", "black"),
                       priors_low = NA, # if you want to show priors for last intervention only then specify values/colors 
                       priors_high = NA,
                       priors_colors = NA,
                       geoname = geo_names,
                       effectiveness=FALSE){
  if(!is.na(npilabel)){
    label <- tibble(npi_label = npilabel,
                    npi_name = npiselection)
  } else {
    label <- tibble(npi_label = npiselection,
                    npi_name = npiselection)
  }

  plot_r <- inference_dat %>%
    filter(npi_name %in% npiselection) %>%
    left_join(geoname)%>%
    left_join(label) %>%
    mutate(name = factor(name, levels = sort(geoname$name, decreasing=TRUE)),
           npi_label = factor(npi_label, levels=label$npi_label))
  
  if(length(periodcolors)<length(npiselection)){
    stop("Specify additional colors")
  }

  periodcolors <- periodcolors[npi_names %in% npiselection]
    
  if(effectiveness==TRUE){
  rc<-plot_r %>%
      ggplot(aes(x=reduc, y=name, col = npi_label)) +
      geom_point(position = position_dodge(0.75)) + 
      geom_linerange(aes(xmin=reducq1, xmax=reducq3, col = npi_label), 
                     position = position_dodge(0.75)) + 
      scale_color_manual(breaks = c(label$npi_label), 
                         values = periodcolors) +
      theme_bw() +
      theme(panel.grid.minor = element_blank(),
            legend.position = "bottom",
            legend.title = element_blank()) +
      scale_x_continuous(expand = c(0,0)) +
      coord_cartesian(xlim = c(0, 1.01)) +
      ylab("County") +
      xlab("Estimated intervention effect (mean and IQR)") +
      guides(color=guide_legend(nrow=2,byrow=TRUE))
    
  } else {
    rc <- plot_r %>%
    ggplot(aes(x=r, y=name, col=npi_label)) + 
    geom_point(position=position_dodge(1)) + 
    scale_color_manual(values = periodcolors)+
    geom_linerange(aes(xmin=rq1, xmax=rq3, col=npi_label), position=position_dodge(1)) +
    theme_bw() +
    theme(panel.grid.minor=element_blank(),
          legend.position = "bottom",
          legend.title = element_blank()) +
    scale_x_continuous(expand = c(0,0)) +
    coord_cartesian(xlim = c(0, 5)) +
    ylab("County") +
    xlab("Estimated reproductive number (mean and IQR)")+
    guides(color=guide_legend(nrow=2,byrow=TRUE))

  }

  if(!is.na(priors_low)){
    for(i in 1:length(priors_low)){
      rc <- rc + 
        annotate("rect", xmin=priors_low[i], xmax=priors_high[i], ymin=-Inf, ymax=Inf,
                 fill=priors_colors[i], alpha=0.1)
    }
  }

return(rc)
}

plot_r_num(inference_r,
           npiselection=npi_names, 
           npilabel=npi_label)

fig_counter <- fig_counter+1 
```

```{r effectiveness, fig.height = 10, eval=infer, fig.cap=cap}
plot_r_num(inference_r, 
          npiselection=npi_names[2:4],
          npilabel=npi_label[2:4],
          effectiveness=TRUE,
          priors_low=0.2,
          priors_high=0.9,
          priors_colors="black")

cap<- paste0("**Fig. ", fig_counter, "**: Estimated effectiveness of school closures (March 13-19) and lockdown (March 19-May 8). Shaded area reflect range of parameter values explored for the post-lockdown period.")

fig_counter <- fig_counter+1
```

## Comparisons with USA Facts

```{r truth_load, include = FALSE}

truth_dat <- get_USAFacts_data() %>%
  filter(FIPS %in% included_geoids) %>%
  rename(date=Update, geoid=FIPS) %>%
  filter(date<forecast_start) %>%
  group_by(date, !!as.symbol(geogroup))%>%
  dplyr::summarize(Confirmed = sum(Confirmed), 
                   Deaths = sum(Deaths, na.rm = TRUE),
                   incidI =sum(incidI),
                   incidDeath=sum(incidDeath)) %>%
  ungroup()

if(run=="state"){
  truth_dat <- truth_dat%>%
    left_join(geodata)%>%
    left_join(geo_names)
  
  if(hosp_eval){
    chhs_dat <- read.csv("data/DPH/covid19data.csv") %>%
      dplyr::select(county = County.Name, 
                    date = Most.Recent.Date, 
                    cumConfirmed = Total.Count.Confirmed, 
                    cumDeaths = Total.Count.Deaths, 
                    currhosp = COVID.19.Positive.Patients, 
                    currhosp_susp = Suspected.COVID.19.Positive.Patients, 
                    currICU = ICU.COVID.19.Positive.Patients,
                    currICU_susp = ICU.COVID.19.Suspected.Patients)
    
    truth_dat <- chhs_dat %>%
      rename(name=county)%>%
      left_join(geo_names) %>%
      mutate(date = as.Date(date, "%m/%d/%Y")) %>%
      filter(date<=forecast_start) %>%
      select(name, date, geoid, hosp=currhosp) %>%
      tibble()%>%
      right_join(truth_dat) %>%
      arrange(date)
}
}

```

```{r model_res_load}

res_state<- arrow::open_dataset(paste0(run_folder,"/hosp/"), 
                                partitioning = c("USPS", "scenario", "death_rate", "date", "lik_type", "is_final", "sim_id")) %>%
    select(time, !!as.symbol(geogroup), scenario, death_rate, sim_id, incidD, incidC, incidH, incidI, hosp_curr)%>%
    filter(time<forecast_start)%>%
    collect() %>%
    group_by(!!as.symbol(geogroup), death_rate, sim_id, scenario) %>%
    mutate(cumDeaths=cumsum(incidD),
           cumHosp=cumsum(incidH),
           cumInf=cumsum(incidI)) %>%
    group_by(!!as.symbol(geogroup), death_rate, sim_id, scenario, time) %>%
    summarize(currHosp=sum(hosp_curr),
              incidD=sum(incidD),
              incidC=sum(incidC),
              cumDeaths=sum(cumDeaths), 
              cumInf=sum(cumInf),
              cumHosp=sum(cumHosp)) %>%
    group_by(!!as.symbol(geogroup), death_rate, time)%>%
    summarize(cumDeaths_5pct=quantile(cumDeaths,probs=pi_lo),
              cumDeaths_95pct=quantile(cumDeaths,probs=pi_hi),
              incidD_5pct=quantile(incidD,probs=pi_lo),
              incidD_95pct=quantile(incidD,probs=pi_hi),
              currHosp_5pct=quantile(currHosp, probs=pi_lo), 
              currHosp_95pct=quantile(currHosp, probs=pi_hi),
              incidC_5pct=quantile(incidC,probs=pi_lo),
              incidC_95pct=quantile(incidC,probs=pi_hi),
              currHosp=mean(currHosp),
              cumDeaths=mean(cumDeaths),
              incidD=mean(incidD),
              incidC=mean(incidC),
              cumInf=mean(cumInf),
              cumHosp=mean(cumHosp))%>%
  mutate(time=as.Date(time),
         death_rate=factor(death_rate, levels=pdeath_levels))

```

`r paste0("**Tab.", tab_counter, "**: Model fit metrics versus USA Facts data")`
```{r mod_metrics, fig.cap=cap}

deaths <- res_state %>% 
  inner_join(truth_dat%>%rename(time=date), by=c(geogroup,"time")) %>%
  group_by(death_rate, time) %>%
  summarize(Deaths = sum(Deaths),
            cumDeaths_5pct = sum(cumDeaths_5pct, pi_lo),
            cumDeaths_95pct = sum(cumDeaths_95pct,pi_hi),
            cumDeaths = sum(cumDeaths)) %>%
  group_by(death_rate) %>%
  mutate(error = abs(cumDeaths-Deaths),
         relative = abs(cumDeaths-Deaths)/Deaths,
         within = if_else(Deaths>cumDeaths_95pct |
                            Deaths<cumDeaths_5pct, 0, 1)) %>%
  summarize(mae = round(sum(error, na.rm=TRUE)/n(),2),
            relative = round(sum(relative, na.rm=TRUE)/n(),3),
            within = round(sum(within, na.rm=TRUE)/n(),3)) %>%
  mutate(Comparison = "Estimated vs Reported Cumulative Deaths")


deaths_I <- res_state %>% 
  inner_join(truth_dat%>%rename(time=date), by=c(geogroup,"time")) %>%
  group_by(death_rate, time) %>%
  summarize(incidDeath = sum(incidDeath),
            incidD_5pct = sum(incidD_5pct, pi_lo),
            incidD_95pct = sum(incidD_95pct,pi_hi),
            incidD = sum(incidD)) %>%
  group_by(death_rate) %>%
  mutate(error = abs(incidD-incidDeath),
         incidDeath=incidDeath+1,# To avoid pesky Inf/NaN
         incidD=incidD+1,
         incidD_5pct=incidD_5pct+1,
         incidD_95pct=incidD_95pct+1,
         relative = abs(incidD-incidDeath)/incidDeath,
         within = if_else(incidDeath>incidD_95pct |
                            incidDeath<incidD_5pct, 0, 1)) %>%
  summarize(mae = round(sum(error, na.rm=TRUE)/n(),2),
            relative = round(sum(relative, na.rm=TRUE)/n(),3),
            within = round(sum(within, na.rm=TRUE)/n(),3)) %>%
  mutate(Comparison = "Estimated vs Reported Incident Deaths")

infects<- res_state %>% 
  inner_join(truth_dat%>%rename(time=date), by=c(geogroup,"time")) %>%
  group_by(death_rate, week=lubridate::floor_date(time,unit="week", week_start=1)) %>%
  summarize(incidC_5pct=sum(incidC_5pct),
            incidC_95pct=sum(incidC_95pct),
            incidC=sum(incidC),
            incidI_conf=sum(incidI))%>%
  group_by(death_rate) %>%
  mutate(error = abs(incidC-incidI_conf),
         incidC=incidC+1, 
         incidI_conf=incidI_conf+1,
         incidC_95pct=incidC_95pct+1,
         incidC_5pct=incidC_5pct+1,
         relative = abs(incidC-incidI_conf)/incidI_conf,
         within = if_else(incidI_conf>incidC_95pct |
                            incidI_conf<incidC_5pct, 0, 1)) %>%
  summarize(mae = round(sum(error)/n(),2),
            relative = round(sum(relative)/n(),3),
            within = round(sum(within)/n(),2)) %>%
  mutate(Comparison = "Estimated vs Reported Incident Cases (aggregated by week)")

if(hosp_eval){
hosp<- res_state%>% 
  inner_join(truth_dat%>%rename(time=date), by=c(geogroup,"time")) %>%
  group_by(death_rate, time) %>%
  summarize(currHosp_5pct=sum(currHosp_5pct, na.rm=TRUE),
            currHosp_95pct=sum(currHosp_95pct,na.rm=TRUE),
            currHosp=sum(currHosp, na.rm=TRUE),
            hosp=sum(hosp, na.rm=TRUE))%>%
  group_by(death_rate) %>%
  mutate(error = abs(currHosp-hosp),
         currHosp=currHosp+1,
         hosp=hosp+1,
         currHosp_5pct=currHosp_5pct+1,
         currHosp_95pct=currHosp_95pct+1,
         relative = abs(currHosp-hosp)/hosp,
         within = if_else(hosp>currHosp_95pct |
                            hosp<currHosp_5pct, 0, 1)) %>%
  summarize(mae = round(sum(error)/n(),2),
            relative = round(sum(relative)/n(),3),
            within = round(sum(within)/n(),2)) %>%
  mutate(Comparison = "Estimated vs Reported Occupied Hospital Beds")}

{if(hosp_eval) bind_rows(deaths, deaths_I, hosp, infects) 
  else(bind_rows(deaths, deaths_I, infects))} %>%
  mutate(death_rate = str_to_title(death_rate)) %>%
  select(Comparison, death_rate, mae, relative, within) %>%
  flextable::flextable()%>%
  flextable::set_header_labels(Comparison="Comparison", death_rate="Death Rate", mae="Mean Absolute Error", relative="Relative Absolute Error\n sum(abs(est-report)/report)/n()", within=paste0("Prop. of points within ", round((pi_hi-pi_lo)*100), "% PI")) %>%
  flextable::merge_v(j = "Comparison") %>%
  flextable::autofit() %>%
  flextable::theme_vanilla()

tab_counter<- tab_counter+1
  
```

## Check 1: Deaths vs. National/State Report  

```{r mdl_v_ob_death, fig.width=20, fig.height=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Modeled deaths vs. latest reported deaths by death rate.")

map1<-res_state%>%
  filter(time==max(truth_dat$date))%>%
  inner_join(truth_dat%>%rename(time=date)) %>% 
  ggplot(aes(x=Deaths, y=cumDeaths, col=death_rate, label = {if(run=="state") name else(USPS)})) +
  ggrepel::geom_text_repel(segment.size = 0.2, alpha = 0.55) +
  geom_point() +
  scale_y_sqrt()+
  scale_x_sqrt()+
  geom_abline()+
  facet_wrap(~death_rate, nrow = 1) +
  theme_bw() +
  theme(legend.position = "none")+
  scale_color_viridis_d(option = "viridis", begin = 0, end = 0.8) +
  xlab("observed deaths") +
  ylab("modeled deaths")

 map1 + coord_cartesian(xlim = c(0, max(map1$cumDeaths)*1.3))  

fig_counter <- fig_counter + 1  

``` 

```{r death_comp_bars, fig.height=10, fig.width=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Modeled vs latest reported deaths by death rate and ", if_else(run=="country", "state.", "county."))

res_state%>%
  filter(time==max(truth_dat$date))%>%
  inner_join(truth_dat%>%rename(time=date)) %>%
  select(time, !!as.symbol(geogroup), cumDeaths, Deaths, death_rate)%>%
  rename(observed=Deaths, modeled=cumDeaths)%>%
  pivot_longer(c(-time, -!!as.symbol(geogroup), -death_rate),
               names_to="source", values_to = "deaths") %>%
  {if(run=="state") left_join(.,truth_dat %>% select(geoid, name)) else(.)} %>%
  ggplot(aes(x= {if(run=="state") name else(!!as.symbol(geogroup))}, y=deaths, fill=source))+
  geom_bar(stat="identity",position=position_dodge()) +
  coord_flip() +
  scale_y_sqrt()+
  facet_wrap(~ death_rate) +
  xlab({if(run=="state") 'Counties' else('State')}) + 
  theme_minimal()

fig_counter <- fig_counter+1
```

```{r heatmap_dat}

mapdat <-res_state%>%
  # group_by(death_rate, !!as.symbol(geogroup)) %>%
  # mutate(lead_death = lead(cum_death, t_report)) %>%
  # ungroup() %>%
  filter(time==max(truth_dat$date))%>%
  inner_join(truth_dat%>%rename(time=date)) %>%
  {if(run=="state") rename(., fips = geoid, full=name)  
    else (mutate(., full=cdlTools::fips(USPS, to="Name"), fips=cdlTools::fips(USPS, to="FIPS")))} %>%
  mutate(cfr=Deaths/Confirmed,
         Deaths=Deaths+1, # to avoid inf or NA
         cumDeaths=cumDeaths+1,
         death_ratio=cumDeaths/Deaths)%>%
  select(fips,full, death_ratio, death_rate, cfr, Deaths, Confirmed, cumDeaths) 
  
shp@data$id = rownames(shp@data)
shp.points = fortify(shp, region="id")

mapdat <- inner_join(shp.points, shp@data, by = "id") %>%
  {if(run=="state") mutate(., fips = as.character(GEOID))
    else(mutate(., full= case_when(STATEFP==10 ~ "Delaware",
                                    TRUE ~ cdlTools::fips(STATEFP, to="Name"))))} %>%
  full_join(mapdat) %>%
  filter(str_detect(group, ".1$")) 

for(i in 1:length((mapdat%>%filter(is.na(death_rate))%>%distinct(NAME))$NAME)){
 temp <- mapdat%>%
    filter(is.na(death_rate))
  
mapdat <- temp%>%
   mutate(death_rate="low") %>%
   bind_rows(mapdat)
mapdat <- temp%>%
   mutate(death_rate="med") %>%
   bind_rows(mapdat)
mapdat <- temp%>%
   mutate(death_rate="high") %>%
   bind_rows(mapdat)
}

mapdat<- mapdat%>%
  filter(!is.na(death_rate)) %>%
  mutate(death_rate=factor(death_rate, levels=pdeath_levels))

```

```{r death_comp_heatmap, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Ratio of modeled deaths to latest reported deaths", if_else(run=="country", " by state.", " by county."))

mapdat %>% 
  ggplot(aes(x=long, y= lat, group=group, fill=death_ratio)) + 
  geom_polygon() + 
  geom_path() +
  facet_wrap(~death_rate, nrow =1) +
  scale_fill_gradient2(trans="log10",midpoint = 0, low="blue",high="red", limits=c(1/60,60),name="mod/obs") +
  theme_void() +
  coord_fixed(1.5)


fig_counter <- fig_counter + 1
```

```{r observed_cfr, echo=FALSE, fig.cap=cap}
cap<- paste0("**Fig.", fig_counter, "**: Observed CFR", if_else(run=="country", " by state.", " by county."))
## Look at ratio of cases to deaths to help think about possible biases in reporting
mapdat %>% 
  filter(death_rate==pdeath_levels[1]) %>%
  ggplot(aes(x=long, y= lat, group=group, fill=cfr)) + 
  geom_polygon() + 
  geom_path() +
  scale_fill_gradient(name="CFR", low="#ffeda0",high="#f03b20") +
  theme_void() +
  coord_fixed(1.5)

fig_counter <- fig_counter+1
```

```{r mdl_v_ob_ts, fig.width = 10, fig.cap=cap}

cap<-paste0("**Fig.", fig_counter, "**: Modeled vs reported deaths over time")

res_state%>%
  inner_join(truth_dat%>%rename(time=date))%>%
  group_by(time, death_rate)%>%
  summarize(cumDeaths=sum(cumDeaths), 
            Deaths=sum(Deaths),
            cumDeaths_5pct=sum(cumDeaths_5pct), 
            cumDeaths_95pct=sum(cumDeaths_95pct))%>%
  ungroup%>%
  ggplot(aes(x=time, y=cumDeaths, ymin=cumDeaths_5pct, ymax=cumDeaths_95pct)) +
  geom_line(col="red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=Deaths)) +
  facet_wrap(~death_rate, ncol=3)+
  scale_y_sqrt()+
  theme_bw()+
  ylab("deaths")

  fig_counter <- fig_counter+1
  

```

```{r, fig.height=10, fig.weight=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Mean absolute error for deaths", if_else(run=="country", " by state.", " by county."))

mae_deaths <- res_state %>%
    group_by(death_rate, !!as.symbol(geogroup)) %>%
    inner_join(truth_dat%>%rename(time=date)) %>%
    mutate(error = abs(cumDeaths-Deaths),
           cumDeaths = cumDeaths+1,
           Deaths=Deaths+1,
           cumDeaths_5pct=cumDeaths_5pct+1,
           cumDeaths_95pct=cumDeaths_95pct+1,
           Deaths = if_else(Deaths == 0, 1, Deaths),
           r_error = abs(cumDeaths-Deaths)/Deaths,
           within = if_else(Deaths>cumDeaths_95pct |
                            Deaths<cumDeaths_5pct, 0, 1)) %>%
    {if(run=="state") group_by(.,death_rate, !!as.symbol(geogroup), name) else(.)} %>%
    filter(!is.na(error)) %>%
    summarize(mae = sum(error, na.rm=TRUE)/n(),
              relative = sum(r_error, na.rm=TRUE)/n(),
              within = sum(within, na.rm=TRUE)/n())

mae_deaths %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=mae, y=group)) +
    geom_col()+
    facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Mean absolute error for deaths") +
  scale_x_sqrt()

fig_counter <- fig_counter+1

```

```{r mae_deaths_r, fig.height=10, fig.weight=10, fig.cap=cap}
cap<- paste0("**Fig.", fig_counter, "**: Relative mean absolute error for deaths", if_else(run=="country", " by state", " by county "))

mae_deaths %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=relative, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) + 
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Relative mean absolute error for deaths") +
  coord_cartesian(xlim = c(0, max((filter(mae_deaths, !is.na(relative), relative!=Inf))$relative))) +
  scale_x_continuous(trans = "log1p", breaks = c(0, 0.25, 0.5, 1, 2, 4))+
    geom_vline(xintercept = 1, linetype="dashed")


fig_counter <- fig_counter+1

```

```{r within_deaths, fig.height=10, fig.weight=10, fig.cap=cap}

cap<-paste0("**Fig.", fig_counter, "**: Proportion of confirmed deaths outside the ", round((pi_hi-pi_lo)*100),"% prediction interval", if_else(run=="country", " by state.", " by county."), " Dashed line represents the overall mean.")

mae_deaths %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=1-within, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) +
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab(paste0("% of estimates outside the ", round((pi_hi-pi_lo)*100),"% prediction interval")) +
  scale_x_continuous(expand = c(0,0))+
  coord_cartesian(xlim = c(0, 1.05))+
    geom_vline(xintercept = 1-(mae_deaths%>%ungroup()%>%summarize(m=mean(within)))$m, linetype="dashed")

fig_counter <- fig_counter+1

```

```{r, fig.height=10, fig.weight=10, fig.cap=cap}

cap<- paste0("**Fig.", fig_counter, "**: Modeled vs reported deaths over time in the four", {if(run=="state") " counties" else(" states")} ," with the largest MAE by death rate.")
## Comparison of cumulative curves by key states
key_group <- mae_deaths %>%
  group_by(death_rate) %>%
  top_n(4, mae) %>%
  mutate(mae = round(mae, 2)) %>%
  {if(run=="state") unite(., "group_mae", name:mae, sep=": ", remove = FALSE) else(unite(., group_mae, !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))}

res_state %>%
  left_join(key_group, by = c(geogroup, "death_rate")) %>%
  filter(!is.na(group_mae)) %>%
  group_by(death_rate,!!as.symbol(geogroup))%>%
  inner_join(truth_dat%>%rename(time=date), by = c("time", geogroup))%>%
  ggplot(aes(x=time, y=cumDeaths, ymin=cumDeaths_5pct, ymax=cumDeaths_95pct)) +
  geom_line(color = "red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=Deaths), col="black") +
  facet_wrap(~ death_rate+group_mae, nrow=3)+
  scale_y_sqrt() +
  theme_bw() + 
  theme(legend.position = "bottom") +
  ylab("deaths") +
  theme(axis.text.x = element_text(angle=45,hjust=1)
        )

fig_counter <- fig_counter+1
  
```

## Check 2: Incident Deaths  

```{r mdl_v_ob_ts_incidD, fig.width = 10, fig.cap=cap}

cap<-paste0("**Fig.", fig_counter, "**: Modeled vs reported incident deaths (aggregated by week) over time.")

res_state%>%
  inner_join(truth_dat%>%rename(time=date))%>%
  group_by(time=lubridate::floor_date(time, unit="weeks"), death_rate)%>%
  summarize(incidD=sum(incidD), 
            incidDeath=sum(incidDeath),
            incidD_5pct=sum(incidD_5pct), 
            incidD_95pct=sum(incidD_95pct))%>%
  ungroup%>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=incidD, ymin=incidD_5pct, ymax=incidD_95pct)) +
  geom_line(col="red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=incidDeath)) +
  facet_wrap(~death_rate, ncol=3)+
  scale_y_sqrt()+
  theme_bw()+
  ylab("deaths")

  fig_counter <- fig_counter+1
  

```

```{r, fig.height=10, fig.weight=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Mean absolute error for incident deaths (aggregated by week)", if_else(run=="country", " by state.", " by county."))

mae_deaths_i <- res_state %>%
  inner_join(truth_dat%>%rename(time=date)) %>%
  {if(run=="state") group_by(., death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="weeks"), name)
    else(group_by(death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="weeks")))} %>%
  summarize(incidD=sum(incidD), 
            incidDeath=sum(incidDeath),
            incidD_5pct=sum(incidD_5pct), 
            incidD_95pct=sum(incidD_95pct))%>%
  mutate(error = abs(incidD-incidDeath),
         incidD = incidD+1,
         incidDeath=incidDeath+1,
         incidD_5pct=incidD_5pct+1,
         incidD_95pct=incidD_95pct+1,
         incidDeath = if_else(incidDeath == 0, 1, incidDeath),
         r_error = abs(incidD-incidDeath)/incidDeath,
         within = if_else(incidDeath>incidD_95pct |
                          incidDeath<incidD_5pct, 0, 1)) %>%
  filter(!is.na(error)) %>%
  {if(run=="state") group_by(., death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="weeks"), name)
    else(group_by(death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="weeks")))} %>%
  summarize(mae = sum(error, na.rm=TRUE)/n(),
            relative = sum(r_error, na.rm=TRUE)/n(),
            within = sum(within, na.rm=TRUE)/n())

mae_deaths_i %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=mae, y=group)) +
    geom_col()+
    facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Mean absolute error for deaths") +
  scale_x_sqrt()

fig_counter <- fig_counter+1

```

```{r mae_deaths_i_r, fig.height=10, fig.weight=10, fig.cap=cap}
cap<- paste0("**Fig.", fig_counter, "**: Relative mean absolute error for incident deaths (aggregated by week)", if_else(run=="country", " by state", " by county "))

mae_deaths %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=relative, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) + 
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Relative mean absolute error for deaths") +
  coord_cartesian(xlim = c(0, max((filter(mae_deaths, !is.na(relative), relative!=Inf))$relative))) +
  scale_x_continuous(trans = "log1p", breaks = c(0, 0.25, 0.5, 1, 2, 4))+
    geom_vline(xintercept = 1, linetype="dashed")


fig_counter <- fig_counter+1

```

```{r within_deaths_i, fig.height=10, fig.weight=10, fig.cap=cap}

cap<-paste0("**Fig.", fig_counter, "**: Proportion of confirmed deaths (aggregated by week) outside the ", round((pi_hi-pi_lo)*100),"% prediction interval", if_else(run=="country", " by state.", " by county."), " Dashed line represents the overall mean.")

mae_deaths %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=1-within, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) +
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab(paste0("% of estimates outside the ", round((pi_hi-pi_lo)*100),"% prediction interval")) +
  scale_x_continuous(expand = c(0,0))+
  coord_cartesian(xlim = c(0, 1.05))+
    geom_vline(xintercept = 1-(mae_deaths%>%ungroup()%>%summarize(m=mean(within)))$m, linetype="dashed")

fig_counter <- fig_counter+1

```

```{r, fig.height=10, fig.weight=10, fig.cap=cap}

cap<- paste0("**Fig.", fig_counter, "**: Modeled vs reported incident deaths (aggregated by week) over time in the four", {if(run=="state") " counties" else(" states")} ," with the largest MAE by death rate.")
## Comparison of cumulative curves by key states
key_group <- mae_deaths %>%
  group_by(death_rate) %>%
  top_n(4, mae) %>%
  mutate(mae = round(mae, 2)) %>%
  {if(run=="state") unite(., "group_mae", name:mae, sep=": ", remove = FALSE) else(unite(., group_mae, !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))}%>%
  select(-name)

res_state %>%
  left_join(key_group, by = c(geogroup, "death_rate")) %>%
  filter(!is.na(group_mae)) %>%
  inner_join(truth_dat%>%rename(time=date), by = c("time", geogroup))%>%
  group_by(death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="weeks"), group_mae)%>%
  summarize(incidD=sum(incidD), 
            incidDeath=sum(incidDeath),
            incidD_5pct=sum(incidD_5pct), 
            incidD_95pct=sum(incidD_95pct))%>%
  group_by(death_rate,!!as.symbol(geogroup))%>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=incidD, ymin=incidD_5pct, ymax=incidD_95pct)) +
  geom_line(color = "red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=incidDeath), col="black") +
  facet_wrap(~ death_rate+group_mae, nrow=3)+
  scale_y_sqrt() +
  theme_bw() + 
  theme(legend.position = "bottom") +
  ylab("deaths") +
  theme(axis.text.x = element_text(angle=45,hjust=1)
        )

fig_counter <- fig_counter+1
  
```


`r ifelse(hosp_eval, "## Check 3: Estimated vs Reported Hospitalizations (CHHS Data)  ", '')`  

```{r mdl_v_ob_hosp, fig.width=20, fig.height=10, fig.cap=cap, eval=hosp_eval}
cap<-paste0("**Fig.", fig_counter, "**: Estimated versus reported occupied hospital beds on ", max(truth_dat$date))
  
res_state%>%filter(time==max(truth_dat$date))%>%
  inner_join(truth_dat%>%rename(time=date)) %>%
  {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
  ggplot(aes(x=hosp, y=currHosp, col=death_rate, label=group)) +
  ggrepel::geom_text_repel(segment.size = 0.2, alpha = 0.75, segment.alpha=0.5) +
  geom_point()+
  scale_y_sqrt()+
  scale_x_sqrt()+
  geom_abline()+
  facet_wrap(~death_rate, nrow=1) +
  theme_bw() +
  theme(legend.position = "none") +
  scale_color_viridis_d(option = "viridis", begin = 0, end = 0.8) +
  xlab(paste0("reported occupied hospital beds"))+
  ylab("modeled occupied hospital beds")
  
  fig_counter <- fig_counter+1

```

```{r mdl_v_ob_ts_hosp, fig.cap=cap, eval=hosp_eval} 
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs reported occupied hospital beds over time by death rate")

res_state%>%
  inner_join(truth_dat%>%rename(time=date))%>%
  group_by(time, death_rate)%>%
  summarize(currHosp=sum(currHosp),
            hosp=sum(hosp),
            currHosp_5pct=sum(currHosp_5pct), 
            currHosp_95pct=sum(currHosp_95pct))%>%
  ungroup()%>%
  ggplot(aes(x=time, y=currHosp, ymin=currHosp_5pct, ymax=currHosp_95pct)) +
  geom_line(color = "red")+
  geom_ribbon(alpha=.1,fill = "red")+
  geom_point(aes(y=hosp)) +
  facet_wrap(~death_rate, nrow=1)+
  theme_bw()+
  scale_y_sqrt()+
  ylab("occupied hospital beds")

fig_counter <- fig_counter+1
  
```

```{r, fig.height=10, fig.width=10, fig.cap=cap, eval=hosp_eval}

mae_hosp <- res_state %>%
    group_by(death_rate, !!as.symbol(geogroup)) %>%
    inner_join(truth_dat%>%rename(time=date)) %>%
    mutate(error = abs(currHosp-hosp),
           hosp=hosp+1,
           currHosp=currHosp+1,
           currHosp_5pct=currHosp_5pct+1,
           currHosp_95pct=currHosp_95pct+1,
           r_error = abs(currHosp-hosp)/hosp,
           within = if_else(hosp>currHosp_95pct |
                            hosp<currHosp_5pct, 0, 1)) %>%
    {if(run=="state") group_by(.,death_rate, !!as.symbol(geogroup), name) else(.)} %>%
    filter(!is.na(error)) %>%
    summarize(mae = sum(error, na.rm=TRUE)/n(),
              relative = sum(r_error, na.rm=TRUE)/n(),
              within = sum(within, na.rm=TRUE)/n())

mae_hosp %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=mae, y=group)) +
    geom_col()+
    facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Mean absolute error for occupied hospital beds") +
  scale_x_sqrt()

```

```{r mae_hosp_r, fig.height=10, fig.weight=10, fig.cap=cap, eval=hosp_eval}
cap<- paste0("**Fig.", fig_counter, "**: Relative mean absolute error for occupied hospital beds", if_else(run=="country", " by state", " by county "))

mae_hosp %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=relative, y=group)) +
    #geom_col()+
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) + 
    #facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Relative mean absolute error for occupied hospital beds") +
  coord_cartesian(xlim = c(0, max((filter(mae_hosp, !is.na(relative), relative!=Inf))$relative))) +
  scale_x_continuous(trans = "log1p", breaks = c(0, 0.25, 0.5, 1, 2, 4))+
    geom_vline(xintercept = 1, linetype="dashed")


fig_counter <- fig_counter+1

```

```{r within_hosp, fig.height=10, fig.weight=10, fig.cap=cap, eval=hosp_eval}

cap<-paste0("**Fig.", fig_counter, "**: Proportion of occupied hospital beds outside the ", round((pi_hi-pi_lo)*100),"% prediction interval", if_else(run=="country", " by state.", " by county."), " Dashed line represents the overall mean.")

mae_hosp %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=1-within, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7)) +
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab(paste0("% of estimates outside the ", round((pi_hi-pi_lo)*100),"% prediction interval")) +
  scale_x_continuous(expand = c(0,0))+
  coord_cartesian(xlim = c(0, 1.05))+
    geom_vline(xintercept = 1-(mae_hosp%>%ungroup()%>%summarize(m=mean(within)))$m, linetype="dashed")

fig_counter <- fig_counter+1

```

```{r key_cum_hosp, fig.height=10, fig.wdith=10,fig.cap=cap, eval=hosp_eval}
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs reported occupied hospital beds over time in the four", {if(run=="state") " by county" else(" by state")}," with the largest MAE by death rate")

key_group <- mae_hosp %>%
  group_by(death_rate) %>%
  top_n(4, mae) %>%
  mutate(mae = round(mae, 2)) %>%
  {if(run=="state") unite(., "group_mae", name:mae, sep=": ", remove = FALSE) else(unite(., group_mae, !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))}%>%
  select(-name)

res_state %>%
  left_join(key_group, by = c(geogroup, "death_rate")) %>%
  filter(!is.na(group_mae)) %>%
  group_by(death_rate,!!as.symbol(geogroup))%>%
  inner_join(truth_dat%>%rename(time=date), by = c("time", geogroup))%>%
  ggplot(aes(x=time, y=currHosp, ymin=currHosp_5pct, ymax=currHosp_95pct)) +
  geom_line(color = "red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=hosp), col="black") +
  facet_wrap(~ death_rate+group_mae, nrow=3)+
  scale_y_sqrt() +
  theme_bw() + 
  theme(legend.position = "bottom") +
  ylab("hosptalizations") +
  theme(axis.text.x = element_text(angle=45,hjust=1)
        )

fig_counter<-fig_counter+1
``` 

`r ifelse(hosp_eval, "## Check 4: Compare estimated and reported cases", "## Check 3: Compare estimated and reported cases")   

```{r lagged_inc_compare, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Estimated and confirmed cases over time by death rate. Cases aggregated by week.")
##Compare to confirmed cases at a national level
usa_sum <-res_state%>%
  inner_join(truth_dat%>%rename(time=date))%>%
  group_by(death_rate, time=lubridate::floor_date(time, unit="week", week_start=1)) %>%
  summarize(incidI_conf=sum(incidI),
            incidC_5pct=sum(incidC_5pct),
            incidC_95pct=sum(incidC_95pct),
            incidC=sum(incidC)) %>%
  ungroup() %>%
  group_by(death_rate)%>%
  arrange(time)%>%
  ungroup()%>%
  mutate(death_rate=factor(death_rate, levels=c("high", "med", "low")))%>%
  filter(time!=max(time))

usa_sum%>%ggplot(aes(x=time, y= incidC, ymin= incidC_5pct, ymax= incidC_95pct, linetype=death_rate))+
  geom_line(col = "red ")+
  geom_ribbon(alpha=.1, aes(fill = death_rate)) +
  geom_point(aes(y=incidI_conf), color="black")+
  ylab("approximate cases") + 
  theme(legend.title = element_text("death rate"))+
  theme_bw()

fig_counter<-fig_counter+1

```


```{r mae_infect, fig.height=10, fig.wdith=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Mean absolute error comparing estimated and confirmed cases in", {if(run=="state") " counties" else(" states")}," by death rate")

mae_infect <-res_state %>%
    inner_join(truth_dat%>%rename(time=date), by = c(geogroup, "time")) %>%
    group_by(death_rate, !!as.symbol(geogroup), time=lubridate::floor_date(time, unit="week", week_start=1)) %>%
  {if(run=="state") group_by(.,death_rate, !!as.symbol(geogroup), name, time) else(.)} %>%
    summarize(incidI_conf=sum(incidI),
             incidC=sum(incidC),
             incidC_5pct=sum(incidC_5pct),
             incidC_95pct=sum(incidC_95pct)) %>%
    mutate(error=abs(incidC-incidI_conf), 
           incidC=incidC+1,
           incidI_conf=incidI_conf+1,
           incidC_5pct=incidC_5pct+1,
           incidC_95pct=incidC_95pct+1,
           within = if_else(incidI_conf>incidC_95pct |
                            incidI_conf<incidC_5pct, 0, 1),
           relative = abs(incidC-incidI_conf)/incidI_conf) %>%
  {if(run=="state") group_by(., death_rate, !!as.symbol(geogroup), name) else(.)} %>%
  filter(!is.na(error)) %>%
  summarize(mae = sum(error)/n(),
            relative = sum(relative)/n(),
            within = sum(within)/n())

mae_infect %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=mae, y=group)) +
    geom_col()+
    facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        )+
  xlab("Mean absolute error for infections")+
  scale_x_sqrt()

fig_counter<-fig_counter+1

```

```{r mae_infect_r, fig.height=10, fig.weight=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Relative mean absolute error comparing estimated and confirmed cases", if_else(run=="country", " by state", " by county "))

mae_infect %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=relative, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7))+
    #facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab("Relative mean absolute error for infections (%)") +
  coord_cartesian(xlim = c(0, max((filter(mae_infect, !is.na(relative), relative!=Inf))$relative))) +
  scale_x_continuous(trans = "log1p", breaks = c(0, 0.25, 0.5, 1, 2, 4))


fig_counter <- fig_counter+1

```

```{r within_infect, fig.height=10, fig.wdith=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Proportion of confirmed cases outside the ", round((pi_hi-pi_lo)*100),"% prediction interval", {if(run=="state") " counties" else(" states")}," by death rate. The dashed line represents the average across counties.")

mae_infect %>%
    {if(run=="state") rename(., group=name) else(rename(.,group=!!as.symbol(geogroup)))} %>%
    ggplot(aes(x=1-within, y=group)) +
    geom_point(aes(col=death_rate), position=position_dodge(0.7))+
    #facet_wrap(~ death_rate)+
    theme_bw() + 
    ylab({if(run=="state") "county" else("state")}) +
    theme(axis.text.x = element_text(angle=45,hjust=1),
        ) +
  xlab(paste0("% of infections outside the ", round((pi_hi-pi_lo)*100),"% prediction interval")) +
  scale_x_continuous(expand = c(0,0))+
  coord_cartesian(xlim = c(0, 1.05))+
  geom_vline(xintercept = 1-(mae_infect%>%ungroup()%>%summarize(m=mean(within)))$m, linetype="dashed")

fig_counter<-fig_counter+1

```

```{r key_infect, fig.height=10, fig.wdith=10, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs confirmed cases over time in the four", {if(run=="state") " counties" else(" states")}," with the largest MAE by death rate")

key_group <- mae_infect %>%
  group_by(death_rate) %>%
  top_n(4, mae) %>%
  mutate(mae = round(mae, 2)) %>%
  {if(run=="state") unite(., "group_mae", name:mae, sep=": ", remove = FALSE) else(unite(., group_mae, !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))}%>%
  select(-name)

res_state %>%
  left_join(key_group, by = c(geogroup, "death_rate")) %>%
  filter(!is.na(group_mae)) %>%
  inner_join(truth_dat%>%rename(time=date))%>%
  # {if(run=="state") rename(., group=Admin2) else(rename(.,group=!!as.symbol(geogroup)))} %>%
  group_by(death_rate, group_mae, time=lubridate::floor_date(time, unit="week", week_start=1))%>%
  summarize(incidI_conf=sum(incidI),
             incidC=sum(incidC),
             incidC_5pct=sum(incidC_5pct),
             incidC_95pct=sum(incidC_95pct)) %>%
  group_by(death_rate, group_mae)%>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=incidC, ymin=incidC_5pct, ymax=incidC_95pct))+
  geom_line(color = "red")+
  geom_ribbon(alpha=0.1, fill="red") +
  geom_point(aes(y=incidI_conf), color="black")+
  facet_wrap(~death_rate+group_mae, nrow=3) +
  scale_y_sqrt()+
  theme_bw()+
  theme(legend.position = "bottom")+
  ylab("approximate cases") 
fig_counter<-fig_counter+1

```

## Diagnostics on various model parameters

### Infections to Hospitalization and Deaths

```{r, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Ratio of cumulative deaths to infections by death rate")
# Assumes default death_rate level for config is "high"
res_state%>% 
  mutate(death_inf_ratio = cumDeaths/cumInf)%>%
  ggplot(aes(x=time, y=death_inf_ratio, color=death_rate)) +
    geom_point(alpha=.02) +
    geom_hline(yintercept=config$outcomes$settings[[1]]$incidD$probability$value$value, col="firebrick2")+
  geom_hline(yintercept=config$outcomes$settings[[1]]$incidD$probability$value$value/2, col="seagreen3")+
  geom_hline(yintercept=config$outcomes$settings[[1]]$incidD$probability$value$value/4, col="royalblue3")+
  theme_bw() +
    guides(fill="none") 

fig_counter<-fig_counter+1
```

```{r, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Ratio of cumulative hospitalizations to infections by death rate")

res_state%>% 
  mutate(hosp_inf_ratio = cumHosp/cumInf)%>%
  ggplot(aes(x=time, y=hosp_inf_ratio, color=death_rate)) +
    geom_point(alpha=.02) +
    geom_hline(yintercept=config$outcomes$settings[[1]]$incidH$probability$value$value, col="firebrick2")+
  geom_hline(yintercept=config$outcomes$settings[[1]]$incidH$probability$value$value/2, col="seagreen3")+
  geom_hline(yintercept=config$outcomes$settings[[1]]$incidH$probability$value$value/4, col="royalblue3")+
  theme_bw() +
    guides(fill="none") 

fig_counter<-fig_counter+1
```
### Hospitalizations and Deaths

```{r, death2hosp, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Ratio of cumulative deaths to hospitalizations by death rate")
  
res_state%>% 
  mutate(death_hosp_ratio = cumDeaths/cumHosp)%>%
  ggplot(aes(x=time, y=death_hosp_ratio, color=death_rate)) +
    geom_point(alpha=.015) +
    geom_hline(yintercept=config$outcomes$settings[[1]]$incidD$probability$value$value/config$outcomes$settings[[1]]$incidH$probability$value$value) +
  theme_bw()

fig_counter<-fig_counter+1

```

```{r, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Ratio of lagged, cumulative deaths to hospitalizations by death rate (3-day lag)")

res_state%>% 
  group_by(!!as.symbol(geogroup)) %>% 
  mutate(lead_death=lead(cumDeaths,3)) %>%
  ungroup() %>%
  mutate(death_hosp_ratio = lead_death/cumHosp)%>%
  ggplot(aes(x=time, y=death_hosp_ratio, color=death_rate)) +
    geom_point(alpha=.015) +
    geom_hline(yintercept=config$outcomes$settings[[1]]$incidD$probability$value$value/config$outcomes$setting[[1]]$incidH$probability$value$value)+
  theme_bw()

fig_counter<-fig_counter+1
```


### Appendix. County-level comparisons

```{r, fig.height=70, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Modeled vs reported deaths over time across", {if(run=="state") " counties " else(" states ")} ,"by death rate.")

res_state %>%
  left_join(mae_deaths, by = c(geogroup, "death_rate")) %>%
  {if(run=="state") unite(., "name_mae", name:mae, sep=": ", remove = FALSE) else(unite(., "name_mae", !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))} %>%
  inner_join(truth_dat%>%rename(time=date))%>%
  ggplot(aes(x=time, y=cumDeaths, ymin=cumDeaths_5pct, ymax=cumDeaths_95pct)) +
  geom_line(color = "red")+
  geom_ribbon(alpha=.1, fill = "red")+
  geom_point(aes(y=Deaths), col="black") +
  facet_grid({if(run=="state") name else(USPS)} ~ death_rate, scales = "free")+
  #geom_text(data = label, label = "mae") +
  #scale_y_sqrt() +
  theme_bw() + 
  theme(legend.position = "bottom") +
  ylab("deaths") +
  theme(axis.text.x = element_text(angle=45,hjust=1))

fig_counter<-fig_counter+1
```

```{r, fig.height=70, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs confirmed incident deaths over time across", {if(run=="state") " counties " else(" states ")} ,"by death rate (aggregated by week).")

res_state %>%
  left_join(mae_infect, by = c(geogroup, "death_rate")) %>%
  {if(run=="state") unite(., "name_mae", name:mae, sep=": ", remove = FALSE) else(unite(., "name_mae", !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))} %>%
  inner_join(truth_dat%>%rename(time=date))%>%
{if(run=="state") group_by(.,death_rate, name_mae, time=lubridate::floor_date(time, unit="week", week_start=1), group=name) else(group_by(.,death_rate, name_mae, time=lubridate::floor_date(time, unit="week", week_start=1), group=USPS))}%>%
  summarize(incidDeath=sum(incidDeath),
             incidD=sum(incidD),
             incidD_5pct=sum(incidD_5pct),
             incidD_95pct=sum(incidD_95pct)) %>%
  group_by(death_rate, group) %>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=incidD, ymin=incidD_5pct, ymax=incidD_95pct))+
  geom_line(color= "red")+
  geom_ribbon(alpha=0.1, fill="red") +
  geom_point(aes(y=incidDeath), color="black")+
  facet_grid(group ~ death_rate, scales = "free")+
  #scale_y_sqrt()+
  theme_bw()+
  theme(legend.position = "bottom")+
  ylab("incident deaths") 

```

```{r, fig.height=70, fig.cap=cap, eval=hosp_eval}
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs confirmed occupied hospital beds over time across", {if(run=="state") " counties " else(" states ")} ,"by death rate.")

res_state %>%
  left_join(mae_hosp, by = c(geogroup, "death_rate")) %>%
  {if(run=="state") unite(., "name_mae", name:mae, sep=": ", remove = FALSE) else(unite(., "name_mae", !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))} %>%
  inner_join(truth_dat%>%rename(time=date))%>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=currHosp, ymin=currHosp_5pct, ymax=currHosp_95pct))+
  geom_line(color= "red")+
  geom_ribbon(alpha=0.1, fill="red") +
  geom_point(aes(y=hosp), color="black")+
  facet_grid({if(run=="state") name else(USPS)} ~ death_rate, scales = "free")+
  #scale_y_sqrt()+
  theme_bw()+
  theme(legend.position = "bottom")+
  ylab("occupied hospital beds") 
```

```{r, fig.height=70, fig.cap=cap}
cap<-paste0("**Fig.", fig_counter, "**: Estimated vs confirmed cases over time across", {if(run=="state") " counties " else(" states ")} ,"by death rate (aggregated by week).")

res_state %>%
  left_join(mae_infect, by = c(geogroup, "death_rate")) %>%
  {if(run=="state") unite(., "name_mae", name:mae, sep=": ", remove = FALSE) else(unite(., "name_mae", !!as.symbol(geogroup):mae, sep=": ", remove = FALSE))} %>%
  inner_join(truth_dat%>%rename(time=date))%>%
{if(run=="state") group_by(.,death_rate, name_mae, time=lubridate::floor_date(time, unit="week", week_start=1), group=name) else(group_by(.,death_rate, name_mae, time=lubridate::floor_date(time, unit="week", week_start=1), group=USPS))}%>%
  summarize(incidI_conf=sum(incidI),
             incidC=sum(incidC),
             incidC_5pct=sum(incidC_5pct),
             incidC_95pct=sum(incidC_95pct)) %>%
  group_by(death_rate, group)%>%
  filter(time!=max(time))%>%
  ggplot(aes(x=time, y=incidC, ymin=incidC_5pct, ymax=incidC_95pct))+
  geom_line(color= "red")+
  geom_ribbon(alpha=0.1, fill="red") +
  geom_point(aes(y=incidI_conf), color="black")+
  facet_grid(group~ death_rate, scales = "free")+
  #scale_y_sqrt()+
  theme_bw()+
  theme(legend.position = "bottom")+
  ylab("cases") 

```